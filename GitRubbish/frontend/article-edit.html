<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘æ–‡ç«  - GitRubbish</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            font-weight: bold;
            margin: 1rem 0 0.5rem;
        }
        .markdown-body h1 { font-size: 1.5rem; }
        .markdown-body h2 { font-size: 1.25rem; }
        .markdown-body h3 { font-size: 1.1rem; }
        .markdown-body p { margin: 0.5rem 0; line-height: 1.6; }
        .markdown-body code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; font-size: 0.9em; }
        .markdown-body pre { background: #f5f5f5; padding: 0.75rem; border-left: 3px solid #000; overflow-x: auto; margin: 0.75rem 0; }
        .markdown-body pre code { background: none; padding: 0; }
    </style>
</head>
<body class="bg-white">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        <div class="flex items-center gap-4 mb-6">
            <button onclick="history.back()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white" title="è¿”å›ä¸Šä¸€é¡µ">
                â† è¿”å›
            </button>
            <input 
                type="text" 
                id="titleInput" 
                placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜..."
                class="flex-1 px-4 py-3 border-2 border-black text-2xl font-bold focus:outline-none"
            >
            <button onclick="showPreview()" class="px-6 py-3 border-2 border-blue-500 text-blue-500 font-bold hover:bg-blue-500 hover:text-white">
                ğŸ‘ï¸ é¢„è§ˆ
            </button>
            <button onclick="saveDraft()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white">
                ä¿å­˜è‰ç¨¿
            </button>
            <button onclick="publishArticle()" class="px-6 py-3 bg-black text-white font-bold hover:bg-gray-800">
                å‘å¸ƒæ–‡ç« 
            </button>
        </div>

        <!-- Markdown å·¥å…·æ  -->
        <div class="border-2 border-black bg-gray-50 p-3 mb-4">
            <div class="flex flex-wrap gap-2 mb-3">
                <button onclick="insertMarkdown('**', '**', 'ç²—ä½“æ–‡å­—')" class="px-3 py-1 border-2 border-black font-bold hover:bg-black hover:text-white transition" title="ç²—ä½“ (Ctrl+B)">
                    <strong>B</strong>
                </button>
                <button onclick="insertMarkdown('*', '*', 'æ–œä½“æ–‡å­—')" class="px-3 py-1 border-2 border-black italic hover:bg-black hover:text-white transition" title="æ–œä½“ (Ctrl+I)">
                    <em>I</em>
                </button>
                <button onclick="insertMarkdown('~~', '~~', 'åˆ é™¤çº¿')" class="px-3 py-1 border-2 border-black hover:bg-black hover:text-white transition" title="åˆ é™¤çº¿">
                    <s>S</s>
                </button>
                <span class="border-l-2 border-black mx-1"></span>
                <button onclick="insertHeading(1)" class="px-3 py-1 border-2 border-black font-bold hover:bg-black hover:text-white transition" title="ä¸€çº§æ ‡é¢˜">
                    H1
                </button>
                <button onclick="insertHeading(2)" class="px-3 py-1 border-2 border-black font-bold hover:bg-black hover:text-white transition" title="äºŒçº§æ ‡é¢˜">
                    H2
                </button>
                <button onclick="insertHeading(3)" class="px-3 py-1 border-2 border-black font-bold hover:bg-black hover:text-white transition" title="ä¸‰çº§æ ‡é¢˜">
                    H3
                </button>
                <span class="border-l-2 border-black mx-1"></span>
                <button onclick="showLinkInput()" class="px-3 py-1 border-2 border-black hover:bg-black hover:text-white transition" title="æ’å…¥é“¾æ¥ (Ctrl+K)">
                    ğŸ”— é“¾æ¥
                </button>
                <button onclick="insertCode()" class="px-3 py-1 border-2 border-black hover:bg-black hover:text-white transition" title="ä»£ç å—">
                    &lt;/&gt;
                </button>
                <button onclick="insertQuote()" class="px-3 py-1 border-2 border-black hover:bg-black hover:text-white transition" title="å¼•ç”¨">
                    "
                </button>
                <span class="border-l-2 border-black mx-1"></span>
                <button onclick="insertList('ul')" class="px-3 py-1 border-2 border-black hover:bg-black hover:text-white transition" title="æ— åºåˆ—è¡¨">
                    â€¢ åˆ—è¡¨
                </button>
                <button onclick="insertList('ol')" class="px-3 py-1 border-2 border-black hover:bg-black hover:text-white transition" title="æœ‰åºåˆ—è¡¨">
                    1. åˆ—è¡¨
                </button>
                <button onclick="insertTable()" class="px-3 py-1 border-2 border-black hover:bg-black hover:text-white transition" title="æ’å…¥è¡¨æ ¼">
                    ğŸ“Š
                </button>
                <span class="border-l-2 border-black mx-1"></span>
                <button onclick="clearEditor()" class="px-3 py-1 border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition" title="æ¸…ç©ºå†…å®¹">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
                <span class="ml-auto text-sm text-gray-600">æç¤º: Ctrl+Z æ’¤é”€ | Ctrl+Y é‡åš</span>
            </div>
            
            <!-- é“¾æ¥è¾“å…¥æ¡† -->
            <div id="linkInputPanel" class="hidden border-t-2 border-black pt-3">
                <div class="flex gap-2 items-center">
                    <input type="text" id="linkText" placeholder="é“¾æ¥æ–‡å­—" class="px-3 py-1 border-2 border-black flex-1">
                    <input type="text" id="linkUrl" placeholder="https://" class="px-3 py-1 border-2 border-black flex-1">
                    <button onclick="confirmLink()" class="px-4 py-1 bg-black text-white font-bold hover:bg-gray-800">
                        æ’å…¥
                    </button>
                    <button onclick="hideLinkInput()" class="px-4 py-1 border-2 border-black hover:bg-black hover:text-white">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
        <div class="grid grid-cols-2 gap-4 mb-6" style="height: 600px;">
            <!-- å·¦ä¾§ç¼–è¾‘åŒº -->
            <div class="border-2 border-black flex flex-col">
                <div class="bg-gray-100 px-4 py-2 border-b-2 border-black font-bold flex items-center justify-between">
                    <span>Markdown ç¼–è¾‘å™¨</span>
                    <span class="text-sm text-gray-600" id="charCount">0 å­—</span>
                </div>
                <textarea 
                    id="contentEditor" 
                    placeholder="å¼€å§‹å†™ä½œ... æ”¯æŒ Markdown è¯­æ³•&#10;&#10;å¿«æ·é”®ï¼š&#10;Ctrl+B: ç²—ä½“&#10;Ctrl+I: æ–œä½“&#10;Ctrl+K: æ’å…¥é“¾æ¥"
                    class="flex-1 p-4 focus:outline-none resize-none font-mono"
                ></textarea>
            </div>

            <!-- å³ä¾§é¢„è§ˆåŒº -->
            <div class="border-2 border-black overflow-y-auto flex flex-col">
                <div class="bg-gray-100 px-4 py-2 border-b-2 border-black font-bold">å®æ—¶é¢„è§ˆ</div>
                <div id="preview" class="markdown-body p-4 flex-1"></div>
            </div>
        </div>

        <!-- æ–‡ç« è®¾ç½® -->
        <div class="border-2 border-black p-6">
            <h3 class="text-lg font-bold mb-4">æ–‡ç« è®¾ç½®</h3>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block font-bold mb-2">åˆ†ç±»</label>
                    <select id="categorySelect" class="w-full px-4 py-2 border-2 border-black focus:outline-none">
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                        <option value="æŠ€æœ¯ç¬”è®°">æŠ€æœ¯ç¬”è®°</option>
                        <option value="ä»£ç ç‰‡æ®µ">ä»£ç ç‰‡æ®µ</option>
                        <option value="é¡¹ç›®ç»éªŒ">é¡¹ç›®ç»éªŒ</option>
                        <option value="å·¥å…·æ¨è">å·¥å…·æ¨è</option>
                    </select>
                </div>
                
                <div>
                    <label class="block font-bold mb-2">æ ‡ç­¾ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</label>
                    <div id="selectedTags" class="flex flex-wrap gap-2 mb-3 min-h-[40px] p-2 border-2 border-dashed border-gray-300 rounded"></div>
                    <div class="border-2 border-black p-3 max-h-48 overflow-y-auto">
                        <div id="availableTags" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="text-sm text-gray-500 mt-1">ç‚¹å‡»æ ‡ç­¾æ·»åŠ /ç§»é™¤ï¼Œå·²é€‰æ ‡ç­¾æ˜¾ç¤ºåœ¨ä¸Šæ–¹</div>
                </div>
            </div>
            
            <div>
                <label class="block font-bold mb-2">æ–‡ç« æ‘˜è¦</label>
                <textarea 
                    id="summaryInput" 
                    placeholder="ç®€çŸ­æè¿°æ–‡ç« å†…å®¹..."
                    class="w-full px-4 py-2 border-2 border-black focus:outline-none resize-none"
                    rows="3"
                    maxlength="200"
                ></textarea>
                <div class="text-sm text-gray-500 mt-1" id="summaryLength">0/200</div>
            </div>
            
            <div class="mt-4">
                <label class="block font-bold mb-2">ğŸ“ é™„ä»¶ä¸Šä¼ </label>
                <div class="border-2 border-dashed border-gray-300 rounded p-4 text-center">
                    <input 
                        type="file" 
                        id="attachmentInput" 
                        accept=".zip,.rar,.7z,.tar,.gz,.java,.py,.js,.html,.css,.txt,.md,.json,.xml,.yml"
                        class="hidden"
                        onchange="handleFileSelect(event)"
                    >
                    <button 
                        type="button"
                        onclick="document.getElementById('attachmentInput').click()"
                        class="px-6 py-2 border-2 border-black font-bold hover:bg-black hover:text-white transition"
                    >
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <p class="text-sm text-gray-500 mt-2">æ”¯æŒ .zip, .rar, .7z ç­‰å‹ç¼©åŒ…åŠä»£ç æ–‡ä»¶ï¼Œæœ€å¤§ 50MB</p>
                    
                    <div id="attachmentInfo" class="hidden mt-4 p-3 bg-gray-50 border-2 border-black">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ğŸ“¦</span>
                                <div class="text-left">
                                    <p class="font-bold" id="attachmentName"></p>
                                    <p class="text-sm text-gray-600" id="attachmentSize"></p>
                                </div>
                            </div>
                            <button 
                                type="button"
                                onclick="removeAttachment()"
                                class="px-3 py-1 border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition"
                            >
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                    
                    <div id="uploadProgress" class="hidden mt-4">
                        <div class="w-full bg-gray-200 h-2">
                            <div id="progressBar" class="bg-black h-2 transition-all" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">ä¸Šä¼ ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] flex flex-col border-4 border-black">
            <!-- é¢„è§ˆå¤´éƒ¨ -->
            <div class="flex items-center justify-between p-4 border-b-2 border-black">
                <h2 class="text-2xl font-bold">æ–‡ç« é¢„è§ˆ</h2>
                <button onclick="closePreview()" class="px-4 py-2 border-2 border-black font-bold hover:bg-black hover:text-white">
                    âœ• å…³é—­
                </button>
            </div>
            
            <!-- é¢„è§ˆå†…å®¹ -->
            <div class="flex-1 overflow-y-auto p-8">
                <!-- æ–‡ç« æ ‡é¢˜ -->
                <h1 id="previewTitle" class="text-4xl font-bold mb-4"></h1>
                
                <!-- æ–‡ç« å…ƒä¿¡æ¯ -->
                <div class="flex items-center gap-4 text-sm text-gray-600 mb-6 pb-6 border-b-2 border-gray-200">
                    <span id="previewCategory"></span>
                    <span id="previewTags"></span>
                    <span id="previewDate"></span>
                </div>
                
                <!-- æ–‡ç« æ‘˜è¦ -->
                <div id="previewSummary" class="bg-gray-50 border-l-4 border-black p-4 mb-6 italic"></div>
                
                <!-- æ–‡ç« å†…å®¹ -->
                <div id="previewContent" class="markdown-body"></div>
                
                <!-- é™„ä»¶ä¿¡æ¯ -->
                <div id="previewAttachment" class="hidden mt-6 p-4 bg-gray-50 border-2 border-black">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ“¦</span>
                        <div>
                            <p class="font-bold">é™„ä»¶</p>
                            <p id="previewAttachmentName" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- é¢„è§ˆåº•éƒ¨æ“ä½œ -->
            <div class="flex items-center justify-between p-4 border-t-2 border-black bg-gray-50">
                <button onclick="closePreview()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white">
                    ç»§ç»­ç¼–è¾‘
                </button>
                <div class="flex gap-3">
                    <button onclick="closePreview(); saveDraft()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white">
                        ä¿å­˜è‰ç¨¿
                    </button>
                    <button onclick="closePreview(); publishArticle()" class="px-6 py-3 bg-black text-white font-bold hover:bg-gray-800">
                        å‘å¸ƒæ–‡ç« 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let articleId = null;
        let isEdit = false;
        let selectedTags = [];
        let attachmentData = null; // å­˜å‚¨ä¸Šä¼ çš„é™„ä»¶ä¿¡æ¯
        
        // å¸¸ç”¨æ ‡ç­¾å»ºè®®ï¼ˆæŒ‰åˆ†ç±»ç»„ç»‡ï¼‰
        const commonTags = {
            'å‰ç«¯å¼€å‘': ['JavaScript', 'TypeScript', 'Vue', 'React', 'Angular', 'HTML', 'CSS', 'Tailwind', 'Bootstrap', 'Webpack', 'Vite'],
            'åç«¯å¼€å‘': ['Node.js', 'Express', 'Nest.js', 'Java', 'Spring Boot', 'Spring Cloud', 'MyBatis', 'Python', 'Django', 'Flask', 'FastAPI', 'Go', 'Gin', 'Rust'],
            'æ•°æ®åº“': ['MySQL', 'PostgreSQL', 'MongoDB', 'Redis', 'SQL', 'NoSQL'],
            'è¿ç»´éƒ¨ç½²': ['Docker', 'Kubernetes', 'CI/CD', 'Linux', 'Nginx', 'Jenkins'],
            'åµŒå…¥å¼': ['åµŒå…¥å¼', 'STM32', 'Arduino', 'ESP32', 'ESP8266', '51å•ç‰‡æœº', 'AVR', 'ARM', 'Cortex-M', 'FreeRTOS', 'RT-Thread', 'HALåº“', 'Keil', 'IAR'],
            'ç‰©è”ç½‘': ['ç‰©è”ç½‘', 'IoT', 'MQTT', 'CoAP', 'LoRaWAN', 'NB-IoT', 'Zigbee', 'Bluetooth', 'æ™ºèƒ½å®¶å±…', 'ä¼ æ„Ÿå™¨', 'è¾¹ç¼˜è®¡ç®—'],
            'é€šç”¨æŠ€èƒ½': ['Git', 'ç®—æ³•', 'æ•°æ®ç»“æ„', 'è®¾è®¡æ¨¡å¼', 'å¾®æœåŠ¡', 'æ€§èƒ½ä¼˜åŒ–', 'å®‰å…¨', 'æµ‹è¯•', 'å‰ç«¯', 'åç«¯', 'å…¨æ ˆ']
        };

        // é…ç½®marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        window.onload = () => {
            if (!requireLogin()) return;
            
            articleId = getUrlParam('id');
            isEdit = !!articleId;
            
            if (isEdit) {
                loadArticle();
            }
            
            // å®æ—¶é¢„è§ˆå’Œå­—æ•°ç»Ÿè®¡
            const editor = document.getElementById('contentEditor');
            editor.addEventListener('input', () => {
                updatePreview();
                updateCharCount();
            });
            
            // æ‘˜è¦å­—æ•°ç»Ÿè®¡
            document.getElementById('summaryInput').addEventListener('input', (e) => {
                document.getElementById('summaryLength').textContent = `${e.target.value.length}/200`;
            });
            
            // é”®ç›˜å¿«æ·é”®
            editor.addEventListener('keydown', handleKeyboardShortcuts);
            
            // åˆå§‹åŒ–æ ‡ç­¾é€‰æ‹©å™¨
            renderAvailableTags();
        };

        // åŠ è½½æ–‡ç« ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
        async function loadArticle() {
            try {
                const response = await axios.get(`${API_BASE_URL}/article/detail`, {
                    params: { id: articleId }
                });
                
                if (response.data.code === 200) {
                    const article = response.data.data;
                    document.getElementById('titleInput').value = article.title || '';
                    document.getElementById('contentEditor').value = article.content || '';
                    document.getElementById('categorySelect').value = article.category || '';
                    document.getElementById('summaryInput').value = article.summary || '';
                    
                    // åŠ è½½æ ‡ç­¾
                    if (article.tags) {
                        selectedTags = article.tags.split(',').map(t => t.trim()).filter(t => t);
                        renderSelectedTags();
                    }
                    
                    // åŠ è½½é™„ä»¶ä¿¡æ¯
                    if (article.attachmentUrl && article.attachmentName) {
                        attachmentData = {
                            url: article.attachmentUrl,
                            originalFilename: article.attachmentName
                        };
                        showAttachmentInfo(article.attachmentName, 0);
                        document.getElementById('attachmentSize').textContent = 'å·²ä¸Šä¼ ';
                    }
                    
                    updatePreview();
                }
            } catch (error) {
                showMessage('åŠ è½½æ–‡ç« å¤±è´¥', 'error');
            }
        }
        
        // æ¸²æŸ“å¯é€‰æ ‡ç­¾
        function renderAvailableTags() {
            const container = document.getElementById('availableTags');
            let html = '';
            
            for (const [category, tags] of Object.entries(commonTags)) {
                html += `
                    <div class="w-full mb-3">
                        <div class="text-xs font-bold text-gray-600 mb-2">${category}</div>
                        <div class="flex flex-wrap gap-2">
                            ${tags.map(tag => `
                                <span class="cursor-pointer px-3 py-1 border-2 border-black text-sm hover:bg-gray-100 transition ${selectedTags.includes(tag) ? 'bg-black text-white' : 'bg-white'}" 
                                      onclick="toggleTag('${tag}')">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©
        function toggleTag(tag) {
            const index = selectedTags.indexOf(tag);
            if (index > -1) {
                selectedTags.splice(index, 1);
            } else {
                selectedTags.push(tag);
            }
            renderSelectedTags();
            renderAvailableTags();
        }
        
        // æ¸²æŸ“å·²é€‰æ ‡ç­¾
        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            if (selectedTags.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">æœªé€‰æ‹©æ ‡ç­¾</span>';
            } else {
                container.innerHTML = selectedTags.map(tag => `
                    <span class="px-3 py-1 bg-black text-white text-sm font-medium cursor-pointer hover:bg-gray-700 transition" onclick="toggleTag('${tag}')">
                        ${tag} Ã—
                    </span>
                `).join('');
            }
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const content = document.getElementById('contentEditor').value;
            const preview = document.getElementById('preview');
            
            if (content.trim()) {
                preview.innerHTML = marked.parse(content);
            } else {
                preview.innerHTML = '<p class="text-gray-400">é¢„è§ˆåŒºåŸŸ</p>';
            }
        }
        
        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        function updateCharCount() {
            const content = document.getElementById('contentEditor').value;
            const count = content.length;
            document.getElementById('charCount').textContent = `${count} å­—`;
        }
        
        // æ’å…¥Markdownè¯­æ³•ï¼ˆæ”¯æŒæ’¤é”€ï¼‰
        function insertMarkdown(before, after, placeholder) {
            const editor = document.getElementById('contentEditor');
            editor.focus();
            
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const text = selectedText || placeholder;
            const newText = before + text + after;
            
            // ä½¿ç”¨ execCommand æ”¯æŒæ’¤é”€
            document.execCommand('insertText', false, newText);
            
            // é€‰ä¸­æ’å…¥çš„æ–‡æœ¬ï¼ˆä¸åŒ…æ‹¬è¯­æ³•ç¬¦å·ï¼‰
            if (!selectedText) {
                editor.setSelectionRange(start + before.length, start + before.length + text.length);
            }
            
            updatePreview();
            updateCharCount();
        }
        
        // æ’å…¥æ ‡é¢˜
        function insertHeading(level) {
            const editor = document.getElementById('contentEditor');
            editor.focus();
            
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const prefix = '#'.repeat(level) + ' ';
            const text = selectedText || 'æ ‡é¢˜æ–‡å­—';
            const newText = prefix + text;
            
            document.execCommand('insertText', false, newText);
            
            if (!selectedText) {
                editor.setSelectionRange(start + prefix.length, start + prefix.length + text.length);
            }
            
            updatePreview();
            updateCharCount();
        }
        
        // æ˜¾ç¤ºé“¾æ¥è¾“å…¥é¢æ¿
        function showLinkInput() {
            const panel = document.getElementById('linkInputPanel');
            const editor = document.getElementById('contentEditor');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            
            document.getElementById('linkText').value = selectedText || '';
            document.getElementById('linkUrl').value = '';
            panel.classList.remove('hidden');
            document.getElementById('linkText').focus();
        }
        
        // éšè—é“¾æ¥è¾“å…¥é¢æ¿
        function hideLinkInput() {
            document.getElementById('linkInputPanel').classList.add('hidden');
            document.getElementById('linkText').value = '';
            document.getElementById('linkUrl').value = '';
        }
        
        // ç¡®è®¤æ’å…¥é“¾æ¥
        function confirmLink() {
            const text = document.getElementById('linkText').value.trim() || 'é“¾æ¥æ–‡å­—';
            const url = document.getElementById('linkUrl').value.trim() || 'https://';
            
            const editor = document.getElementById('contentEditor');
            editor.focus();
            const linkMarkdown = `[${text}](${url})`;
            
            // ä½¿ç”¨ execCommand æ”¯æŒæ’¤é”€
            document.execCommand('insertText', false, linkMarkdown);
            
            updatePreview();
            updateCharCount();
            hideLinkInput();
        }
        
        // æ’å…¥ä»£ç å—
        function insertCode() {
            const editor = document.getElementById('contentEditor');
            editor.focus();
            
            const start = editor.selectionStart;
            const text = '```javascript\n// åœ¨è¿™é‡Œå†™ä»£ç \nconsole.log("Hello World");\n```\n';
            
            // ä½¿ç”¨ execCommand æ”¯æŒæ’¤é”€
            document.execCommand('insertText', false, text);
            
            // å°†å…‰æ ‡å®šä½åˆ°ä»£ç è¯­è¨€ä½ç½®
            editor.setSelectionRange(start + 3, start + 13);
            
            updatePreview();
            updateCharCount();
        }
        
        // æ’å…¥å¼•ç”¨
        function insertQuote() {
            const editor = document.getElementById('contentEditor');
            editor.focus();
            
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const text = selectedText || 'å¼•ç”¨å†…å®¹';
            const newText = '> ' + text;
            
            // ä½¿ç”¨ execCommand æ”¯æŒæ’¤é”€
            document.execCommand('insertText', false, newText);
            
            // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œé€‰ä¸­é»˜è®¤æ–‡æœ¬
            if (!selectedText) {
                editor.setSelectionRange(start + 2, start + 2 + text.length);
            }
            
            updatePreview();
            updateCharCount();
        }
        
        // æ’å…¥åˆ—è¡¨
        function insertList(type) {
            const editor = document.getElementById('contentEditor');
            editor.focus();
            
            const start = editor.selectionStart;
            const prefix = type === 'ul' ? '- ' : '1. ';
            const text = prefix + 'åˆ—è¡¨é¡¹ 1\n' + prefix + 'åˆ—è¡¨é¡¹ 2\n' + prefix + 'åˆ—è¡¨é¡¹ 3\n';
            
            // ä½¿ç”¨ execCommand æ”¯æŒæ’¤é”€
            document.execCommand('insertText', false, text);
            
            // é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ—è¡¨é¡¹
            editor.setSelectionRange(start + prefix.length, start + prefix.length + 5);
            
            updatePreview();
            updateCharCount();
        }
        
        // æ’å…¥è¡¨æ ¼
        function insertTable() {
            const editor = document.getElementById('contentEditor');
            editor.focus();
            
            const start = editor.selectionStart;
            const table = '| åˆ—1 | åˆ—2 | åˆ—3 |\n| --- | --- | --- |\n| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |\n| å†…å®¹4 | å†…å®¹5 | å†…å®¹6 |\n';
            
            // ä½¿ç”¨ execCommand æ”¯æŒæ’¤é”€
            document.execCommand('insertText', false, table);
            
            // é€‰ä¸­ç¬¬ä¸€ä¸ªå•å…ƒæ ¼å†…å®¹
            editor.setSelectionRange(start + 2, start + 4);
            
            updatePreview();
            updateCharCount();
        }
        
        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditor() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                document.getElementById('contentEditor').value = '';
                updatePreview();
                updateCharCount();
            }
        }
        
        // é”®ç›˜å¿«æ·é”®
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        insertMarkdown('**', '**', 'ç²—ä½“æ–‡å­—');
                        break;
                    case 'i':
                        e.preventDefault();
                        insertMarkdown('*', '*', 'æ–œä½“æ–‡å­—');
                        break;
                    case 'k':
                        e.preventDefault();
                        insertLink();
                        break;
                }
            }
        }

        // ä¿å­˜è‰ç¨¿
        async function saveDraft() {
            await saveArticle(0);
        }

        // å‘å¸ƒæ–‡ç« 
        async function publishArticle() {
            await saveArticle(1);
        }

        // ä¿å­˜æ–‡ç« 
        async function saveArticle(status) {
            const title = document.getElementById('titleInput').value.trim();
            const content = document.getElementById('contentEditor').value.trim();
            const category = document.getElementById('categorySelect').value;
            const tags = selectedTags.join(','); // ä½¿ç”¨é€‰ä¸­çš„æ ‡ç­¾æ•°ç»„
            const summary = document.getElementById('summaryInput').value.trim();
            
            if (!title) {
                showMessage('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', 'error');
                return;
            }
            
            if (!content) {
                showMessage('è¯·è¾“å…¥æ–‡ç« å†…å®¹', 'error');
                return;
            }
            
            try {
                const data = {
                    title,
                    content,
                    category,
                    tags,
                    summary,
                    status
                };
                
                // æ·»åŠ é™„ä»¶ä¿¡æ¯
                if (attachmentData) {
                    data.attachmentUrl = attachmentData.url;
                    data.attachmentName = attachmentData.originalFilename;
                }
                
                if (isEdit) {
                    data.id = articleId;
                }
                
                const response = await axios.post(`${API_BASE_URL}/article`, data);
                
                if (response.data.code === 200) {
                    showMessage(status === 0 ? 'è‰ç¨¿ä¿å­˜æˆåŠŸ' : 'æ–‡ç« å‘å¸ƒæˆåŠŸï¼ğŸ‰', 'success');
                    setTimeout(() => {
                        if (status === 1) {
                            // å‘å¸ƒåè·³è½¬åˆ°é¦–é¡µ
                            window.location.href = 'index.html';
                        } else {
                            // ä¿å­˜è‰ç¨¿åè·³è½¬åˆ°ä¸ªäººä¸­å¿ƒ
                            window.location.href = 'profile.html';
                        }
                    }, 1500);
                }
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥', 'error');
            }
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶å¤§å° (50MB)
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 50MB', 'error');
                event.target.value = '';
                return;
            }
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('attachmentInfo').classList.add('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await axios.post(`${API_BASE_URL}/file/upload`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    },
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        document.getElementById('progressBar').style.width = percentCompleted + '%';
                    }
                });
                
                if (response.data.code === 200) {
                    attachmentData = response.data.data;
                    showAttachmentInfo(file.name, file.size);
                    showMessage('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
                } else {
                    showMessage(response.data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showMessage('æ–‡ä»¶ä¸Šä¼ å¤±è´¥', 'error');
            } finally {
                document.getElementById('uploadProgress').classList.add('hidden');
                document.getElementById('progressBar').style.width = '0%';
                event.target.value = '';
            }
        }
        
        // æ˜¾ç¤ºé™„ä»¶ä¿¡æ¯
        function showAttachmentInfo(name, size) {
            document.getElementById('attachmentName').textContent = name;
            document.getElementById('attachmentSize').textContent = formatFileSize(size);
            document.getElementById('attachmentInfo').classList.remove('hidden');
        }
        
        // ç§»é™¤é™„ä»¶
        function removeAttachment() {
            if (confirm('ç¡®å®šè¦åˆ é™¤é™„ä»¶å—ï¼Ÿ')) {
                attachmentData = null;
                document.getElementById('attachmentInfo').classList.add('hidden');
                document.getElementById('attachmentInput').value = '';
                showMessage('é™„ä»¶å·²ç§»é™¤', 'success');
            }
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview() {
            const title = document.getElementById('titleInput').value.trim();
            const content = document.getElementById('contentEditor').value.trim();
            const category = document.getElementById('categorySelect').value;
            const tags = selectedTags.join(', ');
            const summary = document.getElementById('summaryInput').value.trim();
            
            // éªŒè¯
            if (!title) {
                showMessage('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', 'error');
                return;
            }
            
            if (!content) {
                showMessage('è¯·è¾“å…¥æ–‡ç« å†…å®¹', 'error');
                return;
            }
            
            // è®¾ç½®é¢„è§ˆå†…å®¹
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewCategory').textContent = category ? `ğŸ“ ${category}` : '';
            document.getElementById('previewTags').textContent = tags ? `ğŸ·ï¸ ${tags}` : '';
            document.getElementById('previewDate').textContent = `ğŸ“… ${new Date().toLocaleDateString('zh-CN')}`;
            
            // è®¾ç½®æ‘˜è¦
            if (summary) {
                document.getElementById('previewSummary').textContent = summary;
                document.getElementById('previewSummary').classList.remove('hidden');
            } else {
                document.getElementById('previewSummary').classList.add('hidden');
            }
            
            // æ¸²æŸ“ Markdown å†…å®¹
            document.getElementById('previewContent').innerHTML = marked.parse(content);
            
            // æ˜¾ç¤ºé™„ä»¶ä¿¡æ¯
            if (attachmentData) {
                document.getElementById('previewAttachmentName').textContent = attachmentData.originalFilename;
                document.getElementById('previewAttachment').classList.remove('hidden');
            } else {
                document.getElementById('previewAttachment').classList.add('hidden');
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('previewModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // å…³é—­é¢„è§ˆ
        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // ESC é”®å…³é—­é¢„è§ˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePreview();
            }
        });
    </script>
</body>
</html>