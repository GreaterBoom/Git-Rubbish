<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - GitRubbish</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            font-weight: bold;
            margin: 1.5rem 0 1rem;
        }
        .markdown-body h1 { font-size: 2rem; }
        .markdown-body h2 { font-size: 1.5rem; }
        .markdown-body h3 { font-size: 1.25rem; }
        .markdown-body p { margin: 1rem 0; line-height: 1.8; }
        .markdown-body code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
        .markdown-body pre { background: #f5f5f5; padding: 1rem; border-left: 4px solid #000; overflow-x: auto; margin: 1rem 0; }
        .markdown-body pre code { background: none; padding: 0; }
        
        /* å›¾ç‰‡æ ·å¼ - ä¿æŒåŸå§‹å¤§å°å’Œæ¯”ä¾‹ */
        .markdown-body img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem 0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-white">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="border-b-2 border-black bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="history.back()" class="px-4 py-2 border-2 border-black font-bold hover:bg-black hover:text-white transition" title="è¿”å›ä¸Šä¸€é¡µ">
                    â† è¿”å›
                </button>
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                    <img src="picture/002.jpg" alt="GitRubbish Logo" class="w-10 h-10" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-10 h-10 bg-black text-white hidden items-center justify-center font-bold text-lg">
                        GR
                    </div>
                    <h1 class="text-2xl font-bold">GitRubbish</h1>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="editBtn" class="px-4 py-2 bg-black text-white font-bold hover:translate-x-0.5 hover:translate-y-0.5 transition-transform shadow-[2px_2px_0px_0px_rgba(0,0,0,0.3)] hidden">
                    âœï¸ ç¼–è¾‘æ–‡ç« 
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- æ–‡ç« å¤´éƒ¨ -->
        <div id="articleHeader" class="bg-white border-2 border-black p-8 mb-6 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"></div>

        <!-- æ–‡ç« å†…å®¹ -->
        <div id="articleContent" class="markdown-body bg-white border-2 border-black p-8 mb-6 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"></div>

        <!-- æ–‡ç« åº•éƒ¨æ“ä½œ -->
        <div class="bg-white border-2 border-black p-6 mb-8 flex gap-4 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
            <button id="likeBtn" onclick="handleLike()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white transition flex items-center gap-2">
                <span class="text-xl">â¤ï¸</span>
                <span id="likeCount">0</span>
            </button>
            <button id="collectBtn" onclick="handleCollect()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white transition flex items-center gap-2">
                <span class="text-xl">â­</span>
                <span>æ”¶è—</span>
            </button>
        </div>

        <!-- è¯„è®ºåŒº -->
        <div class="bg-white border-2 border-black p-8 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                ğŸ’¬ è¯„è®º (<span id="commentCount">0</span>)
            </h2>
            
            <div id="commentForm" class="mb-6"></div>
            
            <div id="commentList" class="space-y-4"></div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let articleId = null;
        let article = null;
        let isLiked = false;
        let isCollected = false;

        // é…ç½®marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        window.onload = () => {
            articleId = getUrlParam('id');
            if (!articleId) {
                showMessage('æ–‡ç« ä¸å­˜åœ¨', 'error');
                setTimeout(() => window.location.href = 'index.html', 1500);
                return;
            }
            loadArticle();
            loadComments();
            renderCommentForm();
        };

        // åŠ è½½æ–‡ç« è¯¦æƒ…
        async function loadArticle() {
            try {
                const response = await axios.get(`${API_BASE_URL}/article/detail`, {
                    params: { id: articleId }
                });
                
                if (response.data.code === 200) {
                    article = response.data.data;
                    renderArticle();
                }
            } catch (error) {
                showMessage('åŠ è½½æ–‡ç« å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“æ–‡ç« 
        function renderArticle() {
            const currentUser = getCurrentUser();
            const canEdit = currentUser && currentUser.id === article.userId;
            
            // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
            if (canEdit) {
                document.getElementById('editBtn').classList.remove('hidden');
                document.getElementById('editBtn').onclick = () => {
                    window.location.href = `article-edit.html?id=${articleId}`;
                };
            }
            
            // æ¸²æŸ“å¤´éƒ¨
            document.getElementById('articleHeader').innerHTML = `
                <h1 class="text-4xl font-bold mb-6 leading-tight">${article.title}</h1>
                <div class="flex items-center gap-6 text-gray-600 text-sm">
                    <span class="flex items-center gap-2">ğŸ‘¤ ${article.authorName || 'åŒ¿å'}</span>
                    <span class="flex items-center gap-2">ğŸ“… ${formatDateTime(article.createTime)}</span>
                    <span class="flex items-center gap-2">ğŸ‘ï¸ ${article.viewCount || 0}</span>
                </div>
            `;
            
            // æ¸²æŸ“å†…å®¹
            let contentHtml = marked.parse(article.content || '');
            
            // å¦‚æœæœ‰é™„ä»¶ï¼Œæ·»åŠ ä¸‹è½½é“¾æ¥
            if (article.attachmentUrl && article.attachmentName) {
                // ä» URL ä¸­æå– filename å‚æ•°
                const urlParams = new URLSearchParams(article.attachmentUrl.split('?')[1]);
                const filename = urlParams.get('filename');
                
                contentHtml += `
                    <div class="mt-8 p-4 border-2 border-black bg-gray-50">
                        <h3 class="font-bold text-lg mb-3">ğŸ“ é™„ä»¶ä¸‹è½½</h3>
                        <div class="flex items-center justify-between p-3 bg-white border-2 border-black">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">ğŸ“¦</span>
                                <div>
                                    <p class="font-bold">${article.attachmentName}</p>
                                    <p class="text-sm text-gray-600">ç‚¹å‡»ä¸‹è½½é™„ä»¶</p>
                                </div>
                            </div>
                            <button 
                               onclick="downloadAttachment('${filename}', '${article.attachmentName}')"
                               class="px-6 py-2 bg-black text-white font-bold hover:bg-gray-800 transition">
                                ä¸‹è½½
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('articleContent').innerHTML = contentHtml;
            
            // æ›´æ–°ç‚¹èµæ•°
            document.getElementById('likeCount').textContent = article.likeCount || 0;
        }

        // ç‚¹èµ
        async function handleLike() {
            if (!requireLogin()) return;
            
            try {
                const response = await axios.post(`${API_BASE_URL}/article/like`, {
                    articleId: articleId
                });
                
                if (response.data.code === 200) {
                    isLiked = !isLiked;
                    const likeCount = parseInt(document.getElementById('likeCount').textContent);
                    document.getElementById('likeCount').textContent = isLiked ? likeCount + 1 : likeCount - 1;
                    showMessage(isLiked ? 'ç‚¹èµæˆåŠŸ' : 'å–æ¶ˆç‚¹èµ', 'success');
                }
            } catch (error) {
                showMessage('æ“ä½œå¤±è´¥', 'error');
            }
        }

        // æ”¶è—
        async function handleCollect() {
            if (!requireLogin()) return;
            
            try {
                const response = await axios.post(`${API_BASE_URL}/article/collect`, {
                    articleId: articleId
                });
                
                if (response.data.code === 200) {
                    isCollected = !isCollected;
                    showMessage(isCollected ? 'æ”¶è—æˆåŠŸ' : 'å–æ¶ˆæ”¶è—', 'success');
                }
            } catch (error) {
                showMessage('æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // ä¸‹è½½é™„ä»¶
        function downloadAttachment(filename, originalName) {
            // æ„å»ºä¸‹è½½ URL
            const downloadUrl = `${API_BASE_URL}/file/download?filename=${encodeURIComponent(filename)}&originalName=${encodeURIComponent(originalName)}`;
            
            // åˆ›å»ºéšè—çš„ a æ ‡ç­¾è§¦å‘ä¸‹è½½
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = originalName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('å¼€å§‹ä¸‹è½½...', 'success');
        }

        // æ¸²æŸ“è¯„è®ºè¡¨å•
        function renderCommentForm() {
            const token = localStorage.getItem('token');
            const commentForm = document.getElementById('commentForm');
            
            if (token) {
                commentForm.innerHTML = `
                    <textarea 
                        id="commentContent" 
                        placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
                        class="w-full px-4 py-3 border-2 border-black focus:outline-none resize-none"
                        rows="4"
                        maxlength="500"
                    ></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-sm text-gray-500" id="commentLength">0/500</span>
                        <button onclick="submitComment()" class="px-6 py-2 bg-black text-white font-bold hover:bg-gray-800">
                            å‘è¡¨è¯„è®º
                        </button>
                    </div>
                `;
                
                document.getElementById('commentContent').addEventListener('input', (e) => {
                    document.getElementById('commentLength').textContent = `${e.target.value.length}/500`;
                });
            } else {
                commentForm.innerHTML = `
                    <div class="border-2 border-black p-6 text-center">
                        <a href="login.html" class="text-black font-bold hover:underline">ç™»å½•</a> åå‘è¡¨è¯„è®º
                    </div>
                `;
            }
        }

        // æäº¤è¯„è®º
        async function submitComment() {
            const content = document.getElementById('commentContent').value.trim();
            
            if (!content) {
                showMessage('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
                return;
            }
            
            try {
                const response = await axios.post(`${API_BASE_URL}/comment`, {
                    articleId: articleId,
                    content: content
                });
                
                if (response.data.code === 200) {
                    showMessage('è¯„è®ºæˆåŠŸ', 'success');
                    document.getElementById('commentContent').value = '';
                    document.getElementById('commentLength').textContent = '0/500';
                    loadComments();
                }
            } catch (error) {
                showMessage('è¯„è®ºå¤±è´¥', 'error');
            }
        }

        // åŠ è½½è¯„è®ºåˆ—è¡¨
        async function loadComments() {
            try {
                const response = await axios.get(`${API_BASE_URL}/comment/list`, {
                    params: {
                        articleId: articleId,
                        page: 1,
                        size: 100
                    }
                });
                
                if (response.data.code === 200) {
                    const comments = response.data.data.records || [];
                    document.getElementById('commentCount').textContent = comments.length;
                    renderComments(comments);
                }
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥', error);
            }
        }

        // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
        function renderComments(comments) {
            const commentList = document.getElementById('commentList');
            
            if (comments.length === 0) {
                commentList.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— è¯„è®º</div>';
                return;
            }
            
            commentList.innerHTML = comments.map(comment => `
                <div class="border-2 border-gray-200 p-4 hover:border-black transition">
                    <div class="font-bold mb-2 flex items-center gap-2">
                        <span class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center text-sm">
                            ${(comment.userName || 'åŒ¿å')[0].toUpperCase()}
                        </span>
                        ${comment.userName || 'åŒ¿åç”¨æˆ·'}
                    </div>
                    <div class="text-gray-700 mb-2 ml-10">${comment.content}</div>
                    <div class="text-sm text-gray-500 ml-10">${formatDateTime(comment.createTime)}</div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>