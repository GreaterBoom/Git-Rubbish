<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown ç¼–è¾‘å™¨ - GitRubbish</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #fff;
            color: #333;
        }
        
        /* ç¼–è¾‘å™¨å®¹å™¨ */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            height: calc(100vh - 200px);
            border: 2px solid #000;
            overflow: hidden;
        }
        
        .editor-panel, .preview-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .editor-panel {
            border-right: 2px solid #000;
        }
        
        .panel-header {
            background: #000;
            color: #fff;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ç¼–è¾‘å™¨æ–‡æœ¬åŸŸ */
        .editor-textarea {
            flex: 1;
            border: none;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            resize: none;
            outline: none;
            background: #fff;
            overflow-y: auto;
        }
        
        .editor-textarea::-webkit-scrollbar,
        .preview-content::-webkit-scrollbar {
            width: 10px;
        }
        
        .editor-textarea::-webkit-scrollbar-track,
        .preview-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .editor-textarea::-webkit-scrollbar-thumb,
        .preview-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        
        .editor-textarea::-webkit-scrollbar-thumb:hover,
        .preview-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: #f8f8f8;
            border-bottom: 2px solid #000;
        }
        
        .toolbar button {
            padding: 6px 12px;
            border: 2px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .toolbar button:hover {
            background: #000;
            color: #fff;
        }
        
        .toolbar .separator {
            width: 2px;
            background: #ddd;
            margin: 0 4px;
        }
        
        /* é¢„è§ˆåŒºåŸŸ */
        .preview-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fff;
        }
        
        /* Markdown æ ·å¼ */
        .preview-content h1, .preview-content h2, .preview-content h3,
        .preview-content h4, .preview-content h5, .preview-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: bold;
            line-height: 1.3;
        }
        
        .preview-content h1 { 
            font-size: 2em; 
            border-bottom: 3px solid #000; 
            padding-bottom: 0.3em; 
        }
        
        .preview-content h2 { 
            font-size: 1.5em; 
            border-bottom: 2px solid #000; 
            padding-bottom: 0.3em; 
        }
        
        .preview-content h3 { font-size: 1.25em; }
        .preview-content h4 { font-size: 1em; }
        .preview-content h5 { font-size: 0.875em; }
        .preview-content h6 { font-size: 0.85em; color: #666; }
        
        .preview-content p {
            margin-bottom: 1em;
            line-height: 1.7;
        }
        
        .preview-content code {
            background: #f5f5f5;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 90%;
            color: #d63384;
            border: 1px solid #ddd;
        }
        
        .preview-content pre {
            background: #282c34;
            color: #abb2bf;
            padding: 16px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1em 0;
            border: 2px solid #000;
        }
        
        .preview-content pre code {
            background: none;
            padding: 0;
            color: inherit;
            border: none;
        }
        
        .preview-content blockquote {
            border-left: 4px solid #000;
            padding-left: 1em;
            margin: 1em 0;
            color: #666;
            font-style: italic;
        }
        
        .preview-content ul, .preview-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        
        .preview-content li {
            margin: 0.5em 0;
            line-height: 1.6;
        }
        
        .preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            border: 2px solid #000;
        }
        
        .preview-content th, .preview-content td {
            border: 1px solid #000;
            padding: 10px 12px;
            text-align: left;
        }
        
        .preview-content th {
            background: #000;
            color: #fff;
            font-weight: bold;
        }
        
        .preview-content img {
            max-width: 100%;
            height: auto;
            border: 2px solid #000;
            margin: 1em 0;
        }
        
        .preview-content a {
            color: #0066cc;
            text-decoration: none;
            border-bottom: 1px solid #0066cc;
        }
        
        .preview-content a:hover {
            background: #0066cc;
            color: #fff;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 2px solid #000;
            }
            
            .toolbar {
                gap: 4px;
                padding: 8px;
            }
            
            .toolbar button {
                padding: 4px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        <div class="flex items-center gap-4 mb-6 flex-wrap">
            <button onclick="history.back()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white transition">
                â† è¿”å›
            </button>
            <input 
                type="text" 
                id="titleInput" 
                placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜..."
                class="flex-1 min-w-[300px] px-4 py-3 border-2 border-black text-xl font-bold focus:outline-none"
            >
            <button onclick="saveDraft()" class="px-6 py-3 border-2 border-black font-bold hover:bg-black hover:text-white transition">
                ğŸ’¾ è‰ç¨¿
            </button>
            <button onclick="publishArticle()" class="px-6 py-3 bg-black text-white font-bold hover:bg-gray-800 transition">
                âœ“ å‘å¸ƒ
            </button>
        </div>

        <!-- ç¼–è¾‘å™¨å®¹å™¨ -->
        <div class="editor-container">
            <!-- å·¦ä¾§ç¼–è¾‘åŒº -->
            <div class="editor-panel">
                <div class="panel-header">
                    <span>âœï¸ Markdown ç¼–è¾‘</span>
                    <span class="text-sm font-normal" id="charCount">0 å­—</span>
                </div>
                
                <div class="toolbar">
                    <button onclick="insertText('**', '**', 'ç²—ä½“')" title="ç²—ä½“ (Ctrl+B)"><strong>B</strong></button>
                    <button onclick="insertText('*', '*', 'æ–œä½“')" title="æ–œä½“ (Ctrl+I)"><em>I</em></button>
                    <button onclick="insertText('~~', '~~', 'åˆ é™¤çº¿')" title="åˆ é™¤çº¿"><s>S</s></button>
                    <div class="separator"></div>
                    <button onclick="insertHeading(1)" title="ä¸€çº§æ ‡é¢˜">H1</button>
                    <button onclick="insertHeading(2)" title="äºŒçº§æ ‡é¢˜">H2</button>
                    <button onclick="insertHeading(3)" title="ä¸‰çº§æ ‡é¢˜">H3</button>
                    <div class="separator"></div>
                    <button onclick="insertLink()" title="é“¾æ¥ (Ctrl+K)">ğŸ”—</button>
                    <button onclick="insertImage()" title="å›¾ç‰‡ (æ”¯æŒä¸Šä¼ /ç²˜è´´/æ‹–æ‹½)">ğŸ–¼ï¸</button>
                    <button onclick="insertCode()" title="ä»£ç å—">&lt;/&gt;</button>
                    <button onclick="insertQuote()" title="å¼•ç”¨">"</button>
                    <div class="separator"></div>
                    <button onclick="insertList('ul')" title="æ— åºåˆ—è¡¨">â€¢</button>
                    <button onclick="insertList('ol')" title="æœ‰åºåˆ—è¡¨">1.</button>
                    <button onclick="insertTable()" title="è¡¨æ ¼">ğŸ“Š</button>
                    <div class="separator"></div>
                    <button onclick="clearEditor()" title="æ¸…ç©º" style="border-color: #dc2626; color: #dc2626;">ğŸ—‘ï¸</button>
                </div>
                
                <textarea 
                    class="editor-textarea" 
                    id="markdown-editor" 
                    placeholder="# å¼€å§‹å†™ä½œ...

åœ¨è¿™é‡Œè¾“å…¥ Markdown å†…å®¹ï¼Œå³ä¾§å®æ—¶é¢„è§ˆ

## å¿«æ·é”®
- **Ctrl+B**: ç²—ä½“
- **Ctrl+I**: æ–œä½“  
- **Ctrl+K**: é“¾æ¥
- **Ctrl+S**: ä¿å­˜è‰ç¨¿

## å›¾ç‰‡ä¸Šä¼ 
- ç‚¹å‡» ğŸ–¼ï¸ æŒ‰é’®ä¸Šä¼ 
- ç›´æ¥ç²˜è´´å›¾ç‰‡ (Ctrl+V)
- æ‹–æ‹½å›¾ç‰‡åˆ°ç¼–è¾‘å™¨

## ç¤ºä¾‹

**ç²—ä½“æ–‡æœ¬** *æ–œä½“æ–‡æœ¬* ~~åˆ é™¤çº¿~~

> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨

\`\`\`javascript
console.log('Hello, Markdown!');
\`\`\`

- åˆ—è¡¨é¡¹ 1
- åˆ—è¡¨é¡¹ 2

| è¡¨å¤´1 | è¡¨å¤´2 |
| --- | --- |
| å†…å®¹1 | å†…å®¹2 |
"></textarea>
            </div>

            <!-- å³ä¾§é¢„è§ˆåŒº -->
            <div class="preview-panel">
                <div class="panel-header">
                    <span>ğŸ‘ï¸ å®æ—¶é¢„è§ˆ</span>
                </div>
                <div class="preview-content" id="markdown-preview"></div>
            </div>
        </div>

        <!-- æ–‡ç« è®¾ç½® -->
        <div class="mt-6 border-2 border-black">
            <div class="bg-black text-white px-6 py-3 font-bold">âš™ï¸ æ–‡ç« è®¾ç½®</div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block font-bold mb-2">ğŸ“ åˆ†ç±»</label>
                        <select id="categorySelect" class="w-full px-4 py-2 border-2 border-black focus:outline-none">
                            <option value="">é€‰æ‹©åˆ†ç±»</option>
                            <option value="æŠ€æœ¯ç¬”è®°">æŠ€æœ¯ç¬”è®°</option>
                            <option value="ä»£ç ç‰‡æ®µ">ä»£ç ç‰‡æ®µ</option>
                            <option value="é¡¹ç›®ç»éªŒ">é¡¹ç›®ç»éªŒ</option>
                            <option value="å·¥å…·æ¨è">å·¥å…·æ¨è</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block font-bold mb-2">ğŸ·ï¸ æ ‡ç­¾ï¼ˆå¤šé€‰ï¼‰</label>
                        <div id="selectedTags" class="flex flex-wrap gap-2 mb-2 min-h-[42px] p-2 border-2 border-dashed border-gray-300 bg-gray-50"></div>
                        <div class="border-2 border-black p-3 max-h-48 overflow-y-auto bg-white">
                            <div id="availableTags" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label class="block font-bold mb-2">ğŸ“ æ–‡ç« æ‘˜è¦</label>
                    <textarea 
                        id="summaryInput" 
                        placeholder="ç®€çŸ­æè¿°æ–‡ç« å†…å®¹ï¼ˆé€‰å¡«ï¼‰..."
                        class="w-full px-4 py-2 border-2 border-black focus:outline-none resize-none"
                        rows="3"
                        maxlength="200"
                    ></textarea>
                    <div class="text-sm text-gray-500 mt-1" id="summaryLength">0/200</div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let articleId = null;
        let isEdit = false;
        let selectedTags = [];
        
        const editor = document.getElementById('markdown-editor');
        const preview = document.getElementById('markdown-preview');
        const charCount = document.getElementById('charCount');
        
        // å¸¸ç”¨æ ‡ç­¾
        const commonTags = {
            'å‰ç«¯': ['JavaScript', 'TypeScript', 'Vue', 'React', 'HTML', 'CSS'],
            'åç«¯': ['Java', 'Spring Boot', 'Python', 'Node.js', 'Go'],
            'æ•°æ®åº“': ['MySQL', 'Redis', 'MongoDB'],
            'å·¥å…·': ['Git', 'Docker', 'Linux']
        };
        
        window.onload = function() {
            if (!requireLogin()) return;
            
            articleId = getUrlParam('id');
            isEdit = !!articleId;
            
            if (isEdit) {
                loadArticle();
            }
            
            renderAvailableTags();
            updatePreview();
            updateCharCount();
            
            // æ‘˜è¦å­—æ•°ç»Ÿè®¡
            document.getElementById('summaryInput').addEventListener('input', (e) => {
                document.getElementById('summaryLength').textContent = `${e.target.value.length}/200`;
            });
        };
        
        // å®æ—¶æ›´æ–°é¢„è§ˆ
        editor.addEventListener('input', function() {
            updatePreview();
            updateCharCount();
        });
        
        // ç²˜è´´å›¾ç‰‡ä¸Šä¼ 
        editor.addEventListener('paste', async function(e) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const file = items[i].getAsFile();
                    await uploadImageFile(file);
                    break;
                }
            }
        });
        
        // æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
        editor.addEventListener('dragover', function(e) {
            e.preventDefault();
            editor.style.background = '#f0f0f0';
        });
        
        editor.addEventListener('dragleave', function(e) {
            e.preventDefault();
            editor.style.background = '#fff';
        });
        
        editor.addEventListener('drop', async function(e) {
            e.preventDefault();
            editor.style.background = '#fff';
            
            const files = e.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
                if (files[i].type.startsWith('image/')) {
                    await uploadImageFile(files[i]);
                }
            }
        });
        
        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const markdownText = editor.value;
            const htmlContent = marked.parse(markdownText);
            preview.innerHTML = htmlContent;
            
            // è¯­æ³•é«˜äº®
            if (window.hljs) {
                preview.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }
        
        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const count = editor.value.length;
            charCount.textContent = `${count} å­—`;
        }
        
        // æ’å…¥æ–‡æœ¬
        function insertText(before, after, placeholder) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const textToInsert = selectedText || placeholder;
            const newText = before + textToInsert + after;
            
            editor.setRangeText(newText, start, end, 'end');
            editor.focus();
            updatePreview();
            updateCharCount();
        }
        
        // æ’å…¥æ ‡é¢˜
        function insertHeading(level) {
            const start = editor.selectionStart;
            const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
            const prefix = '#'.repeat(level) + ' ';
            
            editor.setRangeText(prefix, lineStart, lineStart, 'end');
            editor.focus();
            updatePreview();
        }
        
        // æ’å…¥é“¾æ¥
        function insertLink() {
            showModal('æ’å…¥é“¾æ¥', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-bold mb-2">é“¾æ¥åœ°å€</label>
                        <input type="text" id="linkUrl" placeholder="https://example.com" class="w-full px-4 py-2 border-2 border-black focus:outline-none">
                    </div>
                    <div>
                        <label class="block font-bold mb-2">é“¾æ¥æ–‡å­—</label>
                        <input type="text" id="linkText" placeholder="é“¾æ¥æ–‡å­—" class="w-full px-4 py-2 border-2 border-black focus:outline-none">
                    </div>
                </div>
            `, () => {
                const url = document.getElementById('linkUrl').value.trim();
                const text = document.getElementById('linkText').value.trim();
                if (url) {
                    insertText('[', `](${url})`, text || url);
                }
            });
        }
        
        // æ’å…¥å›¾ç‰‡
        function insertImage() {
            showModal('æ’å…¥å›¾ç‰‡', `
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 p-6 text-center bg-gray-50 hover:bg-gray-100 transition cursor-pointer" onclick="document.getElementById('imageFileInput').click()">
                        <input type="file" id="imageFileInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                        <div class="text-4xl mb-2">ğŸ“¤</div>
                        <div class="font-bold mb-1">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                        <div class="text-sm text-gray-500">æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                        <div class="text-xs text-gray-400 mt-2">æ”¯æŒ JPG, PNG, GIF (æœ€å¤§ 5MB)</div>
                    </div>
                    <div class="text-center text-gray-500">æˆ–</div>
                    <div>
                        <label class="block font-bold mb-2">å›¾ç‰‡åœ°å€</label>
                        <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 border-2 border-black focus:outline-none">
                    </div>
                    <div>
                        <label class="block font-bold mb-2">å›¾ç‰‡æè¿°</label>
                        <input type="text" id="imageAlt" placeholder="å›¾ç‰‡æè¿°" class="w-full px-4 py-2 border-2 border-black focus:outline-none">
                    </div>
                    <div id="uploadProgress" class="hidden">
                        <div class="w-full bg-gray-200 h-2 rounded">
                            <div id="uploadProgressBar" class="bg-black h-2 rounded transition-all" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-600 text-center mt-2">ä¸Šä¼ ä¸­...</div>
                    </div>
                </div>
            `, () => {
                const url = document.getElementById('imageUrl').value.trim();
                const alt = document.getElementById('imageAlt').value.trim();
                if (url) {
                    insertText('![', `](${url})`, alt || 'å›¾ç‰‡');
                }
            });
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆä»æ–‡ä»¶é€‰æ‹©å™¨ï¼‰
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            await uploadImageToModal(file, event);
        }
        
        // ä¸Šä¼ å›¾ç‰‡åˆ°æ¨¡æ€æ¡†
        async function uploadImageToModal(file, event) {
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å° (5MB)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                if (event) event.target.value = '';
                return;
            }
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            if (progressDiv) progressDiv.classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await axios.post(`${API_BASE_URL}/file/upload-image`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    },
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        if (progressBar) {
                            progressBar.style.width = percentCompleted + '%';
                        }
                    }
                });
                
                if (response.data.code === 200) {
                    const imageUrl = response.data.data.url;
                    // è‡ªåŠ¨å¡«å……å›¾ç‰‡åœ°å€
                    const urlInput = document.getElementById('imageUrl');
                    const altInput = document.getElementById('imageAlt');
                    if (urlInput) urlInput.value = imageUrl;
                    if (altInput && !altInput.value) altInput.value = file.name.replace(/\.[^/.]+$/, '');
                    
                    showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                } else {
                    showMessage(response.data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
            } finally {
                if (progressDiv) progressDiv.classList.add('hidden');
                if (progressBar) progressBar.style.width = '0%';
                if (event) event.target.value = '';
            }
        }
        
        // ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼ˆç²˜è´´/æ‹–æ‹½ï¼‰
        async function uploadImageFile(file) {
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showMessage('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å° (5MB)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                return;
            }
            
            showMessage('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await axios.post(`${API_BASE_URL}/file/upload-image`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                if (response.data.code === 200) {
                    const imageUrl = response.data.data.url;
                    const imageName = file.name.replace(/\.[^/.]+$/, '');
                    // ç›´æ¥æ’å…¥åˆ°ç¼–è¾‘å™¨
                    insertText('![', `](${imageUrl})`, imageName);
                    showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                } else {
                    showMessage(response.data.message || 'ä¸Šä¼ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
            }
        }
        
        // æ’å…¥ä»£ç å—
        function insertCode() {
            showModal('æ’å…¥ä»£ç å—', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-bold mb-2">é€‰æ‹©è¯­è¨€</label>
                        <select id="codeLang" class="w-full px-4 py-2 border-2 border-black focus:outline-none">
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="python">Python</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="sql">SQL</option>
                            <option value="bash">Bash</option>
                            <option value="json">JSON</option>
                            <option value="plaintext">çº¯æ–‡æœ¬</option>
                        </select>
                    </div>
                </div>
            `, () => {
                const lang = document.getElementById('codeLang').value;
                insertText(`\`\`\`${lang}\n`, '\n\`\`\`', '// åœ¨è¿™é‡Œè¾“å…¥ä»£ç ');
            });
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, content, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white border-4 border-black p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <div class="mb-6">${content}</div>
                    <div class="flex gap-3 justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 border-2 border-black font-bold hover:bg-gray-100">
                            å–æ¶ˆ
                        </button>
                        <button id="modalConfirm" class="px-6 py-2 bg-black text-white font-bold hover:bg-gray-800">
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            setTimeout(() => {
                const firstInput = modal.querySelector('input, select');
                if (firstInput) firstInput.focus();
            }, 100);
            
            // ç¡®å®šæŒ‰é’®äº‹ä»¶
            modal.querySelector('#modalConfirm').onclick = () => {
                onConfirm();
                modal.remove();
            };
            
            // ESC é”®å…³é—­
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // æ’å…¥å¼•ç”¨
        function insertQuote() {
            const start = editor.selectionStart;
            const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
            editor.setRangeText('> ', lineStart, lineStart, 'end');
            editor.focus();
            updatePreview();
        }
        
        // æ’å…¥åˆ—è¡¨
        function insertList(type) {
            const start = editor.selectionStart;
            const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
            const prefix = type === 'ul' ? '- ' : '1. ';
            editor.setRangeText(prefix, lineStart, lineStart, 'end');
            editor.focus();
            updatePreview();
        }
        
        // æ’å…¥è¡¨æ ¼
        function insertTable() {
            const table = '\n| åˆ—1 | åˆ—2 | åˆ—3 |\n| --- | --- | --- |\n| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |\n';
            insertText('', '', table);
        }
        
        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditor() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
                editor.value = '';
                updatePreview();
                updateCharCount();
            }
        }
        
        // é”®ç›˜å¿«æ·é”®
        editor.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        insertText('**', '**', 'ç²—ä½“');
                        break;
                    case 'i':
                        e.preventDefault();
                        insertText('*', '*', 'æ–œä½“');
                        break;
                    case 'k':
                        e.preventDefault();
                        insertLink();
                        break;
                    case 's':
                        e.preventDefault();
                        saveDraft();
                        break;
                }
            }
        });
        
        // æ¸²æŸ“å¯é€‰æ ‡ç­¾
        function renderAvailableTags() {
            const container = document.getElementById('availableTags');
            let html = '';
            
            for (const [category, tags] of Object.entries(commonTags)) {
                html += `<div class="w-full mb-2">
                    <div class="text-xs font-bold text-gray-600 mb-1">${category}</div>
                    <div class="flex flex-wrap gap-2">`;
                
                tags.forEach(tag => {
                    const isSelected = selectedTags.includes(tag);
                    html += `<button type="button" class="px-3 py-1 border border-black text-sm hover:bg-black hover:text-white transition ${isSelected ? 'bg-black text-white' : 'bg-white'}" onclick="toggleTag('${tag}')">${tag}</button>`;
                });
                
                html += `</div></div>`;
            }
            
            container.innerHTML = html;
        }
        
        // åˆ‡æ¢æ ‡ç­¾
        function toggleTag(tag) {
            const index = selectedTags.indexOf(tag);
            if (index > -1) {
                selectedTags.splice(index, 1);
            } else {
                selectedTags.push(tag);
            }
            renderSelectedTags();
            renderAvailableTags();
        }
        
        // æ¸²æŸ“å·²é€‰æ ‡ç­¾
        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            if (selectedTags.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">æœªé€‰æ‹©æ ‡ç­¾</span>';
            } else {
                container.innerHTML = selectedTags.map(tag => 
                    `<button type="button" class="px-3 py-1 bg-black text-white text-sm font-medium hover:bg-gray-700 transition" onclick="toggleTag('${tag}')">${tag} Ã—</button>`
                ).join('');
            }
        }
        
        // åŠ è½½æ–‡ç« 
        async function loadArticle() {
            try {
                const response = await axios.get(`${API_BASE_URL}/article/detail`, {
                    params: { id: articleId }
                });
                
                if (response.data.code === 200) {
                    const article = response.data.data;
                    document.getElementById('titleInput').value = article.title || '';
                    editor.value = article.content || '';
                    document.getElementById('categorySelect').value = article.category || '';
                    document.getElementById('summaryInput').value = article.summary || '';
                    
                    if (article.tags) {
                        selectedTags = article.tags.split(',').map(t => t.trim()).filter(t => t);
                        renderSelectedTags();
                        renderAvailableTags();
                    }
                    
                    updatePreview();
                    updateCharCount();
                }
            } catch (error) {
                showMessage('åŠ è½½æ–‡ç« å¤±è´¥', 'error');
            }
        }
        
        // ä¿å­˜è‰ç¨¿
        async function saveDraft() {
            await saveArticle(0);
        }
        
        // å‘å¸ƒæ–‡ç« 
        async function publishArticle() {
            await saveArticle(1);
        }
        
        // ä¿å­˜æ–‡ç« 
        async function saveArticle(status) {
            const title = document.getElementById('titleInput').value.trim();
            const content = editor.value.trim();
            const category = document.getElementById('categorySelect').value;
            const tags = selectedTags.join(',');
            const summary = document.getElementById('summaryInput').value.trim();
            
            if (!title) {
                showMessage('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', 'error');
                return;
            }
            
            if (!content) {
                showMessage('è¯·è¾“å…¥æ–‡ç« å†…å®¹', 'error');
                return;
            }
            
            try {
                const data = {
                    title,
                    content,
                    category,
                    tags,
                    summary,
                    status
                };
                
                if (isEdit) {
                    data.id = articleId;
                }
                
                const response = await axios.post(`${API_BASE_URL}/article`, data);
                
                if (response.data.code === 200) {
                    showMessage(status === 0 ? 'è‰ç¨¿ä¿å­˜æˆåŠŸ' : 'æ–‡ç« å‘å¸ƒæˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.href = status === 1 ? 'index.html' : 'profile.html';
                    }, 1500);
                }
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥', 'error');
            }
        }
    </script>
</body>
</html>
