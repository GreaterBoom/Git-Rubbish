<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©ä¸­å¿ƒ - GitRubbish</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <style>
        .chat-container {
            height: calc(100vh - 200px);
        }
        .message-list {
            height: calc(100% - 120px);
            overflow-y: auto;
        }
        .message-list::-webkit-scrollbar {
            width: 8px;
        }
        .message-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .message-list::-webkit-scrollbar-thumb {
            background: #000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="border-b-2 border-black sticky top-0 bg-white z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="history.back()" class="px-4 py-2 border-2 border-black font-bold hover:bg-black hover:text-white transition md:hidden" title="è¿”å›ä¸Šä¸€é¡µ">
                    â†
                </button>
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                    <img src="picture/002.jpg" alt="GitRubbish Logo" class="w-10 h-10" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-10 h-10 bg-black text-white hidden items-center justify-center font-bold text-lg">
                        GR
                    </div>
                    <h1 class="text-2xl font-bold">GitRubbish</h1>
                </div>
            </div>
            
            <nav class="hidden md:flex items-center gap-2">
                <a href="index.html" class="font-bold px-3 py-2 hover:bg-gray-100 transition text-sm">é¦–é¡µ</a>
                <a href="chat.html" class="font-bold px-3 py-2 bg-black text-white transition text-sm">èŠå¤©</a>
                <a href="users.html" class="font-bold px-3 py-2 hover:bg-gray-100 transition text-sm">ç¤¾åŒºæˆå‘˜</a>
            </nav>
            
            <div class="flex items-center gap-3">
                <div id="userActions"></div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- åœ¨çº¿æˆå‘˜åˆ—è¡¨ -->
            <aside class="lg:col-span-1">
                <div class="bg-white border-2 border-black p-5 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] sticky top-24">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        ğŸ‘¥ åœ¨çº¿æˆå‘˜ (<span id="onlineCount">0</span>)
                    </h3>
                    <div id="onlineUsers" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
                    </div>
                </div>
            </aside>

            <!-- èŠå¤©åŒºåŸŸ -->
            <main class="lg:col-span-3">
                <div class="bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                    <div class="border-b-2 border-black p-4 bg-gray-50">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            ğŸ’¬ å…¬å…±èŠå¤©å®¤
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">æ¬¢è¿æ¥åˆ° GitRubbish å›¢é˜ŸèŠå¤©ä¸­å¿ƒ</p>
                    </div>

                    <div class="chat-container p-4">
                        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                        <div id="messageList" class="message-list space-y-3 mb-4">
                            <!-- æ¶ˆæ¯å°†åŠ¨æ€åŠ è½½ -->
                        </div>

                        <!-- è¾“å…¥åŒºåŸŸ -->
                        <div class="border-t-2 border-black pt-4">
                            <div class="flex gap-3">
                                <textarea 
                                    id="messageInput" 
                                    placeholder="è¾“å…¥æ¶ˆæ¯... (Ctrl+Enter å‘é€)"
                                    class="flex-1 px-4 py-3 border-2 border-black focus:outline-none focus:border-gray-600 transition resize-none"
                                    rows="3"
                                    maxlength="500"
                                ></textarea>
                                <button 
                                    onclick="sendMessage()" 
                                    class="px-6 py-3 bg-black text-white font-bold hover:translate-x-0.5 hover:translate-y-0.5 transition-transform shadow-[2px_2px_0px_0px_rgba(0,0,0,0.3)] h-fit"
                                >
                                    å‘é€
                                </button>
                            </div>
                            <div class="flex justify-between items-center mt-3 text-sm">
                                <span id="charCount" class="text-gray-600 font-medium">0/500</span>
                                <span class="text-gray-500">æç¤ºï¼šCtrl+Enter å¿«é€Ÿå‘é€</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let currentUser = null;
        let messagePolling = null;
        let lastMessageId = 0;
        let isSending = false; // é˜²æ­¢é‡å¤æ˜¾ç¤º

        window.onload = () => {
            if (!requireLogin()) return;
            
            currentUser = getCurrentUser();
            checkLoginStatus();
            loadMessages();
            loadOnlineUsers();
            startMessagePolling();
            
            // å­—ç¬¦è®¡æ•°
            document.getElementById('messageInput').addEventListener('input', (e) => {
                document.getElementById('charCount').textContent = `${e.target.value.length}/500`;
            });
            
            // Ctrl+Enter å‘é€
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    sendMessage();
                }
            });
        };

        window.onbeforeunload = () => {
            if (messagePolling) {
                clearInterval(messagePolling);
            }
        };

        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userInfoStr = localStorage.getItem('userInfo');
            const userActions = document.getElementById('userActions');
            
            if (token && userInfoStr) {
                try {
                    const user = JSON.parse(userInfoStr);
                    userActions.innerHTML = `
                        <a href="profile.html" class="px-4 py-2 border-2 border-black font-bold hover:bg-black hover:text-white transition">
                            ğŸ‘¤ ${user.nickname || user.username}
                        </a>
                    `;
                } catch (e) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                }
            }
        }

        // åŠ è½½æ¶ˆæ¯
        async function loadMessages() {
            try {
                const response = await axios.get(`${API_BASE_URL}/chat/messages`, {
                    params: {
                        page: 1,
                        size: 50
                    }
                });
                
                if (response.data.code === 200) {
                    const messages = response.data.data.records || [];
                    if (messages.length > 0) {
                        lastMessageId = messages[0].id;
                    }
                    renderMessages(messages.reverse());
                    scrollToBottom();
                }
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥', error);
            }
        }

        // è½®è¯¢æ–°æ¶ˆæ¯
        function startMessagePolling() {
            messagePolling = setInterval(async () => {
                // å¦‚æœæ­£åœ¨å‘é€æ¶ˆæ¯ï¼Œè·³è¿‡æœ¬æ¬¡è½®è¯¢
                if (isSending) {
                    return;
                }
                
                try {
                    const response = await axios.get(`${API_BASE_URL}/chat/messages`, {
                        params: {
                            afterId: lastMessageId,
                            size: 10
                        }
                    });
                    
                    if (response.data.code === 200) {
                        const newMessages = response.data.data.records || [];
                        if (newMessages.length > 0) {
                            lastMessageId = newMessages[0].id;
                            appendMessages(newMessages.reverse());
                            scrollToBottom();
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢æ¶ˆæ¯å¤±è´¥', error);
                }
            }, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages(messages) {
            const messageList = document.getElementById('messageList');
            
            if (messages.length === 0) {
                messageList.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-4xl mb-4">ğŸ’¬</div>
                        <p>æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            messageList.innerHTML = messages.map(msg => createMessageHTML(msg)).join('');
        }

        // è¿½åŠ æ–°æ¶ˆæ¯
        function appendMessages(messages) {
            const messageList = document.getElementById('messageList');
            messages.forEach(msg => {
                const messageHTML = createMessageHTML(msg);
                messageList.insertAdjacentHTML('beforeend', messageHTML);
            });
            
            // æ£€æŸ¥æ¶ˆæ¯æ•°é‡ï¼Œè¶…è¿‡100æ¡åˆ™æ¸…ç©ºæ—§æ¶ˆæ¯
            const allMessages = messageList.querySelectorAll('.flex.gap-3');
            if (allMessages.length > 100) {
                // åªä¿ç•™æœ€æ–°çš„100æ¡
                const messagesToRemove = allMessages.length - 100;
                for (let i = 0; i < messagesToRemove; i++) {
                    allMessages[i].remove();
                }
            }
        }

        // åˆ›å»ºæ¶ˆæ¯HTML
        function createMessageHTML(msg) {
            const isOwn = currentUser && currentUser.id === msg.userId;
            const userName = msg.userName || 'åŒ¿åç”¨æˆ·';
            const avatar = userName.charAt(0).toUpperCase();
            
            return `
                <div class="flex gap-3 ${isOwn ? 'flex-row-reverse' : ''}">
                    <div class="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">
                        ${avatar}
                    </div>
                    <div class="flex-1 ${isOwn ? 'text-right' : ''}">
                        <div class="flex items-center gap-2 mb-1 ${isOwn ? 'justify-end' : ''}">
                            <span class="font-bold text-sm">${userName}</span>
                            <span class="text-xs text-gray-500">${formatDateTime(msg.createTime)}</span>
                        </div>
                        <div class="inline-block px-4 py-2 ${isOwn ? 'bg-black text-white' : 'bg-gray-100'} border-2 border-black max-w-lg break-words">
                            ${escapeHtml(msg.content)}
                        </div>
                    </div>
                </div>
            `;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) {
                showMessage('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }
            
            try {
                isSending = true; // æ ‡è®°æ­£åœ¨å‘é€
                
                const response = await axios.post(`${API_BASE_URL}/chat/send`, {
                    content: content
                });
                
                if (response.data.code === 200) {
                    input.value = '';
                    document.getElementById('charCount').textContent = '0/500';
                    
                    // ç«‹å³æ˜¾ç¤ºæ–°æ¶ˆæ¯
                    const newMsg = response.data.data;
                    lastMessageId = newMsg.id; // æ›´æ–°æœ€åæ¶ˆæ¯ID
                    appendMessages([newMsg]);
                    scrollToBottom();
                    
                    // å»¶è¿Ÿæ¢å¤è½®è¯¢ï¼Œé¿å…é‡å¤è·å–
                    setTimeout(() => {
                        isSending = false;
                    }, 1000);
                }
            } catch (error) {
                showMessage('å‘é€å¤±è´¥', 'error');
                isSending = false;
            }
        }

        // åŠ è½½åœ¨çº¿ç”¨æˆ·


        function scrollToBottom() {
            const messageList = document.getElementById('messageList');
            messageList.scrollTop = messageList.scrollHeight;
        }

        // åŠ è½½åœ¨çº¿ç”¨æˆ·
        async function loadOnlineUsers() {
            try {
                // ä»åç«¯è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
                const response = await axios.get(`${API_BASE_URL}/user/list`);
                
                if (response.data.code === 200) {
                    // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ï¼ˆä¸é™åˆ¶æ•°é‡ï¼‰
                    const users = response.data.data.map(user => ({
                        id: user.id,
                        nickname: user.nickname || user.username,
                        status: 'online'
                    }));
                    renderOnlineUsers(users);
                } else {
                    // ä½¿ç”¨å½“å‰ç”¨æˆ·ä½œä¸ºåœ¨çº¿ç”¨æˆ·
                    const users = [
                        { id: currentUser?.id, nickname: currentUser?.nickname || currentUser?.username, status: 'online' }
                    ];
                    renderOnlineUsers(users);
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                // ä½¿ç”¨å½“å‰ç”¨æˆ·ä½œä¸ºåœ¨çº¿ç”¨æˆ·
                const users = [
                    { id: currentUser?.id, nickname: currentUser?.nickname || currentUser?.username, status: 'online' }
                ];
                renderOnlineUsers(users);
            }
        }

        function renderOnlineUsers(users) {
            const onlineUsers = document.getElementById('onlineUsers');
            document.getElementById('onlineCount').textContent = users.length;
            
            onlineUsers.innerHTML = users.map(user => `
                <div class="flex items-center gap-2 p-2 border-2 border-gray-200 hover:border-black transition cursor-pointer" onclick="viewUserProfile(${user.id})">
                    <div class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center text-sm font-bold">
                        ${(user.nickname || 'U').charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-sm">${user.nickname || 'ç”¨æˆ·'}</div>
                    </div>
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                </div>
            `).join('');
        }
        
        // æŸ¥çœ‹ç”¨æˆ·ä¸»é¡µ
        function viewUserProfile(userId) {
            if (userId === currentUser?.id) {
                // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œè·³è½¬åˆ°ä¸ªäººä¸­å¿ƒ
                window.location.href = 'profile.html';
            } else {
                // è·³è½¬åˆ°ç”¨æˆ·ä¸»é¡µ
                window.location.href = `user-profile.html?userId=${userId}`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>